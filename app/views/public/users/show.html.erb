<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">

      <div class="card shadow-sm p-4 mb-5 border-0 rounded-lg">
        <div class="d-flex align-items-center">
          <%# ユーザーのアバター表示（画像があれば表示、なければデフォルトアイコン） %>
          <div class="mr-4">
            <% if @user.profile_image.attached? %>
              <%= image_tag @user.profile_image.variant(resize_to_limit: [120, 120]), class: "rounded-circle border", style: "width: 120px; height: 120px; object-fit: cover;" %>
            <% else %>
              <div class="rounded-circle bg-light d-flex align-items-center justify-content-center border" style="width: 120px; height: 120px;">
                <i class="fas fa-user fa-3x text-muted"></i>
              </div>
            <% end %>
          </div>
          
          <div>
            <h2 class="mb-1">
              <%= @user.name %>
            </h2>
            <p class="text-muted mb-3"><%= @user.email %></p>

            <p>
              フォロー数 : <%= @user.followings.count %>
              フォロワー数 : <%= @user.followers.count %>
            </p>

            <% if user_signed_in? && @user == current_user %>
              <%= link_to "マイページへ", mypage_path, class: "btn btn-outline-info btn-sm" %>
            <% end %>
          </div>
        </div>

        <h4 class="mt-4 mb-2 border-bottom pb-1">自己紹介</h4>
        <p class="text-secondary">
          <%= @user.introduction.present? ? safe_join(@user.introduction.split("\n"), tag(:br)) : "自己紹介文はまだありません。" %>
        </p>
      </div>

      <div class="row">
        
        <%# --- リーダーコミュニティ (修正済み) --- %>
        <div class="col-md-6 mb-4">
          <div class="card h-100 p-3">
            <h5 class="card-title"><i class="fas fa-crown text-danger"></i> リーダーコミュニティ (<%= @owned_communities.total_count %>)</h5> <%# total_countで総数を表示 %>
            <% if @owned_communities.present? %>
              <ul class="list-group list-group-flush">
                <% @owned_communities.each do |community| %> <%# ⬇️ .take(3)を削除し、@owned_communitiesを直接使用 %>
                  <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                    <%= link_to community.name, community_path(community) %>
                    <span class="badge badge-secondary badge-pill"><%= community.members.count %> メンバー</span>
                  </li>
                <% end %>
              </ul>
              <div class="d-flex justify-content-center mt-3">
                <%= paginate @owned_communities, param_name: :owned_page %> <%# ⬇️ _paginatedを削除し、:owned_pageを使用 %>
              </div>
            <% else %>
              <p class="text-muted small mt-2">リーダーを務めるコミュニティはありません。</p>
            <% end %>
          </div>
        </div>

        <%# --- 参加コミュニティ (修正済み) --- %>
        <div class="col-md-6 mb-4">
          <div class="card h-100 p-3">
            <h5 class="card-title"><i class="fas fa-users text-success"></i> 参加コミュニティ (<%= @joined_communities.total_count %>)</h5> <%# total_countで総数を表示 %>
            <% if @joined_communities.present? %>
              <ul class="list-group list-group-flush">
                <% @joined_communities.each do |community| %> <%# ⬇️ .take(3)を削除し、@joined_communitiesを直接使用 %>
                  <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                    <%= link_to community.name, community_path(community) %>
                    <span class="badge badge-secondary badge-pill"><%= community.members.count %> メンバー</span>
                  </li>
                <% end %>
              </ul>
              <div class="d-flex justify-content-center mt-3">
                <%= paginate @joined_communities, param_name: :joined_page %> <%# ⬇️ _paginatedを削除し、:joined_pageを使用 %>
              </div>
            <% else %>
              <p class="text-muted small mt-2">現在、参加しているコミュニティはありません。</p>
            <% end %>
          </div>
        </div>
      </div>

      <hr class="my-5">

      <%# --- 主催イベント (修正済み) --- %>
      <h3 class="mb-3"><i class="fas fa-calendar-alt"></i> 主催イベント (<%= @created_events.total_count %>)</h3> <%# total_countで総数を表示 %>
      <% if @created_events.present? %>
        <div class="row">
          <% @created_events.each do |event| %> <%# ⬇️ .take(4)を削除し、@created_eventsを直接使用 %>
            <div class="col-md-6 mb-4">
              <div class="card h-100 p-3">
                <p class="mb-1"><small class="text-muted"><%= event.community.name %></small></p>
                <h5><%= link_to event.title, community_event_path(event.community, event) %></h5>
                <p class="small text-secondary mb-1">
                  🗓 <%= event.start_at.strftime("%Y/%m/%d %H:%M") %>
                </p>
                <span class="badge badge-primary w-50 text-center"><%= event.pace_required_i18n %></span>
              </div>
            </div>
          <% end %>
        </div>
        <div class="d-flex justify-content-center mt-3">
          <%= paginate @created_events, param_name: :event_page %> <%# ⬇️ _paginatedを削除し、:event_pageを使用 %>
        </div>
      <% else %>
        <div class="alert alert-light text-center" role="alert">
          主催した公開イベントはありません。
        </div>
      <% end %>

      <hr class="my-5">

      <%# --- 投稿履歴 (軽微修正) --- %>
      <h3 class="mb-3"><i class="fas fa-feather-alt"></i> 投稿履歴</h3>
      <% if @posts.present? %>
        <div class="list-group mb-3">
          <% @posts.each do |post| %>
            <%= link_to post_path(post), class: "list-group-item list-group-item-action flex-column align-items-start" do %>
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1"><%= post.title %></h5>
                <small class="text-muted"><%= time_ago_in_words(post.created_at) %>前</small>
              </div>
              <p class="mb-1"><%= truncate(post.body, length: 100) %></p>
            <% end %>
          <% end %>
        </div>
        <div class="d-flex justify-content-center">
          <%= paginate @posts, param_name: :post_page %>
        </div>
      <% else %>
        <div class="alert alert-light text-center" role="alert">
          まだ公開された投稿はありません。
        </div>
      <% end %>

      <div class="text-center mt-5">
        <%= link_to "コミュニティ一覧に戻る", communities_path, class: "btn btn-outline-secondary px-4" %>
      </div>
      
    </div>
  </div>
</div>